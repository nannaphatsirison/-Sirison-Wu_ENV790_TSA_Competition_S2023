---
title: "Competition_Forecast_RMD"
author: "Nannaphat Sirison, Lynn Wu" 
output: html_document
date: "2023-04-03"
---

##  INTRODUCTION

```{r setup, include=FALSE}
#Installing required packages
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(kableExtra)
library(readxl)
library(zoo)
library(openxlsx)
library(writexl)
```
This project aims to utilize time series forecasting tools to model hourly load demand. As population increases, and as renewable energy penetration increases, it is important to develop models that help forecast load that can help utilities understand load patterns and long term trends in load. This can help utilities plan for how much generation and capacity they can should be procuring to make sure that load is appropriately met. 

## EXPLORING THE DATA

```{r, include= FALSE}
#Loading in the data set
df<-read_excel("load.xlsx")
```

```{r, include = FALSE}
#DATA WRANGLING
#Taking the average across hours of the day
df$hourly_mean <- rowMeans(df[,3:26])

#Selecting only necessary columns: data and hourly mean
df <- df[, c("date","hourly_mean")]

#Making date column a date format
df$date <- ymd(df$date)

```

```{r, include = FALSE}
#Drop NAs
df1 <- df %>% drop_na()

#Converting to time series object (2005.1.1-2010.12.31)
ts <- msts(df1[,2], seasonal.periods = c(7,365.25),start=c(2005,01,01),end=c(2010,12,31))

```

```{r, echo= FALSE}
#Initial plot of time series
ts_plot<-ggplot(df1,aes(x=date, y=hourly_mean))+
  geom_line()+
  labs(y="Load", x= "Year", title="Daily Load (averaged across hours)")+
  theme_minimal()
plot(ts_plot)

#Summary of time series
ts_summary<-summary(ts)
ts_summary
```

The dataset we are working in provides hourly data from January 1, 2005 to December 31,2010. We have aggregated hourly data into daily data, by taking the average across 24 hours of each day. 

In the plot above, we see that across the time series we there are obvious fluctuations/ oscillations. These fluctuations are not surprising; it is a common for load to vary based on seasons and time of day, for example, higher load is expected during summer time than spring time. 

Observed minimum load is at 1525, and maximum load is at 7545. Mean load is 3329 and median load is 3182. From the plot we observe an overally increasing trend.  

## DATA ANALYSIS

Before running a time series forecast model, we prepare and transform the data to fit the needs of time series forecasting. Before selecting models for time series forecasting, we examine ACF and PACF plots of the original, un-transformed time series (shown below).

```{r}
#Original Series: ACF and PACF Plots
par(mfrow=c(1,2))
ACF_Plot <- Acf(ts, lag = 40, plot = TRUE,main="ACF of Hourly Mean")
PACF_Plot <- Pacf(ts, lag = 40,plot = TRUE,main="PACF of Hourly Mean")
```
>Plots not only show strong seasonality but also non-stationarity due to the slow decay.

We then examine the decomposition of the original time series to identify seasonality and trend. Decomposition of the time series is displayed below: 

```{r}
#Original Series: Decomposition
ts %>% mstl() %>%
  autoplot()
```
>The trend has a narrow range compared to seasonal components. Both weekly and yearly pattern have strong scales and trend components in daily data.

##FORECASTING DAILY ACTIVE POWER

```{r message=FALSE, warning=FALSE}
#create a subset for training purpose (2005-2009)
n_for = 365
ts_train <- subset(ts,end = length(ts)-n_for)

#create a subset for testing purpose (2009-2010)
ts_test <- subset(ts, start = length(ts)-n_for)

autoplot(ts_train)
autoplot(ts_test)
```

#Model 1: STL + ETS 

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Fit and forecast STL + ETS model to data
ETS_fit <-  stlf(ts_train,h=365)
```

```{r}
#Plot model + observed data
autoplot(ts) +
  autolayer(ETS_fit, series="STL + ETS",PI=FALSE) +
  ylab("Hourly Load")
```

We observe that that it follows the seasonality well (as observed by the coincidental oscillation of the red and black series); however, the magnitude of the forecast does not fit the data we observe well, where observed data has a greater magnitude than the forecasted data. 

```{r, include = FALSE}
#WRANGLING FOR KAGGLE SUBMISSION

#Generate 2011 output for Kaggle competition
ETS_fit_kaggle <-  stlf(ts,h=59)
#Save ETS_fit_kaggle as a dataframe
ETS_fit_kaggle_df <- as.data.frame(ETS_fit_kaggle$mean)

#Read in submission template
submission_template<-read_excel("submission_template.xlsx")
#Merge df
submission_template_ETS <- cbind(submission_template,ETS_fit_kaggle_df)
#Remove extra column
submission_template_ETS <- submission_template_ETS[, c("date","x")]
#Rename column from "x" to "load"
colnames(submission_template_ETS) <- c("date","load")

#Save out dataframe as excel file to submit to Kaggle 
write.xlsx(submission_template_ETS, file = "Sirison_Wu_1.xlsx")

```

#Model 2: ARIMA + FOURIER terms

```{r ARIMA, echo=TRUE, message=FALSE, warning=FALSE}

ARIMA_Four_fit <- auto.arima(ts_train, 
                             seasonal=FALSE, 
                             lambda=0,
                             xreg=fourier(ts_train, 
                                          K=c(2,48))
                             )

#Forecast with ARIMA fit
ARIMA_Four_for <- forecast(ARIMA_Four_fit,
                           xreg=fourier(ts_train,
                                        K=c(2,48),
                                        h=365),
                           h=365
                           ) 

#Plot foresting results
autoplot(ARIMA_Four_for) + ylab("Hourly Load")

#Plot model + observed data
autoplot(ts) +
  autolayer(ARIMA_Four_for, series="ARIMA_FOURIER",PI=FALSE) +
  ylab("Hourly Load")
```

```{r, include = FALSE}
#WRANGLING FOR KAGGLE SUBMISSION

#Generate 2011 output for Kaggle competition
ARIMA_FOURIER_fit_kaggle <-  forecast(ARIMA_Four_for,h=59)
#Save ETS_fit_kaggle as a dataframe
ARIMA_FOURIER_fit_kaggle_df <- as.data.frame(ARIMA_FOURIER_fit_kaggle$mean)

#Merge df
submission_template_ARIMA <- cbind(submission_template,ARIMA_FOURIER_fit_kaggle_df)
#Remove extra column
submission_template_ARIMA <- submission_template_ARIMA[, c("date","x")]
#Rename column from "x" to "load"
colnames(submission_template_ARIMA) <- c("date","load_Model2")

#Merge model1 and model2
combine_model_final<- merge(submission_template_ETS,submission_template_ARIMA,by="date")
colnames(combine_model_final) <- c("date","load_Model1","load_Model2")

#Save out dataframe as excel file to submit to Kaggle 
write.xlsx(combine_model_final, file = "Sirison_Wu_2.xlsx")

```


#Model 3: TBATS

```{r, echo=TRUE, message=FALSE, warning=FALSE}
TBATS_fit <- tbats(ts_train)
TBATS_for <- forecast(TBATS_fit, h=365)
```

```{r}
#Plot TBATS forecast vs observed data 
autoplot(ts) +
  autolayer(TBATS_for, series="TBATS",PI=FALSE)+
  ylab("Hourly Load") 
```

```{r, include = FALSE}
#WRANGLING FOR KAGGLE SUBMISSION
#Generate 2011 output for Kaggle competition
TBATS_fit_kaggle <- forecast(TBATS_fit, h=59)
#Save TBATS_fit_kaggle as a dataframe
TBATS_fit_kaggle_df <- as.data.frame(TBATS_fit_kaggle$mean)

#Read in submission template
submission_template<-read_excel("submission_template.xlsx")
#Merge df
submission_template_TBATS <- cbind(submission_template,TBATS_fit_kaggle_df)
#Remove extra column
submission_template_TBATS <- submission_template_TBATS[, c("date","x")]
#Rename column from "x" to "load"
colnames(submission_template_TBATS) <- c("date","load")

#Save out dataframe as excel file to submit to Kaggle 
write.xlsx(submission_template_TBATS, file = "Sirison_Wu_3.xlsx")
```

#Model 4. Neutral Network Time Series Forecasts
```{r}
NN_fit <- nnetar(ts_train,p=1,P=0,xreg=fourier(ts_train, K=c(2,12)))
```


##EXAMINING ACCURACY OF FORECASTS 

#Model 1: STL + ETS Accuracy 
```{r, include = FALSE}
ETS_scores <- accuracy(ETS_fit$mean,ts_test)  
```

#Model 2: Arima + Fourier Accuracy 
```{r, include = FALSE}
ARIMA_scores <- accuracy(ARIMA_Four_for$mean,ts_test)
```

#Model 3: TBATS Accuracy 
```{r, include = FALSE}
TBATS_scores <- accuracy(TBATS_for$mean,ts_test)
```

#Model 4: XXX Accuracy 
```{r}

```


#Accuracy Comparison
```{r}
#Graph of all forecast models 
autoplot(ts) +
  autolayer(ETS_fit, series="STL + ETS",PI=FALSE) +
  autolayer(ARIMA_Four_for, series="ARIMA_FOURIER",PI=FALSE) +
  autolayer(TBATS_for, series="TBATS",PI=FALSE)+
  ylab("Hourly Load") 
```



```{r}
#Table of accuracy statistics
```


##CONCLUSION




